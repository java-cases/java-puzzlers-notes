# 谜题 27：变幻莫测的 i 值 

## 背景

左移操作符（<<）。

## 代码

下面的程序记录在终止前有多少次迭代的循环。那么，它打印的是什么呢？ 

```java
public class Shifty {
    public static void main(String[] args) {
        int i = 0;
 
        while (-1 << i != 0)
            i++;
 
        System.out.println(i);
    }
}
```

## 陷阱

常量-1 是所有 32 位都被置位的 int 数值（0xffffffff）。

左移操作符将 0 移入到由移位所空出的右边的最低位，因此表达式（-1 << i）将 i 最右边的位设置 为 0，并保持其余的 32 - i 位为 1。很明显，这个循环将完成 32 次迭代，因为 -1 << i 对任何小于 32 的 i 来说都不等于 0。

你可能期望终止条件测试在 i 等于 32 时返回 false，从而使程序打印 32，但是它打印的并不是 32。实际上，它不 会打印任何东西，而是进入了一个无限循环。 

## 解惑

**问题在于（-1 << 32）等于-1 而不是 0**，因为移位操作符之使用其右操作数的低 5 位作为移位长度，或者是低 6 位，如果其左操作数是一个 long 类数值。这条规则作用于全部的三个移位操作符：<<、>>和>>>。

- int 类型移位长度总是介于 0 到 31 之间，如果左操作数是 long 类型的，则介于 0 到 63 之间。
- 移位长度是对 32 取余的，如果左操作数是 long 类型的，则对 64 取余。
- **如果试图对一个 int 数值 移位 32 位，或者是对一个 long 数值移位 64 位，都只能返回这个数值自身的值**。 **没有任何移位长度可以让一个 int 数值丢弃其所有的 32 位，或者是让一个 long 数值丢弃其所有的 64 位**。 

## 解决办法或规则

**修订**：我们不是让-1 **重复地移位不同的移位长度**，而是将前一次移位操作的结果保存起来，并且让它在每一次迭 代时都向左再移 1 位。 

```java
public class Shifty {
    public static void main(String[] args) {
        int distance = 0;
 
        for (int val = -1; val != 0; val <<= 1)
            distance++;
 
        System.out.println(distance);
    }
}
```

**一条普遍的原则**：**如果可能的话，移位长度应该是常量**。 如果移位长度紧盯着你不放，那么你让其值超过 31，或者如果左操作数是 long 类型的，让其值超过 63 的可能性就会大大降低。

**教训**：

- **移位长度是对 32 取余的，或者如果左操作数是 long 类型的，则对 64 取余**。因此，**使用任何移位操作符和移位长度，都不可能将一个数值的所有位全部移走**。
- 我们也不可能用右移操作符来执行左移操作，反之亦然。
- 如果可能的话，请使用常量的移位长度，如果移位长度不能设为常量，那么就要千万当心。  